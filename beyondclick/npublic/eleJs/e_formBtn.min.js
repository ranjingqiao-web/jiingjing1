"use strict";
function _typeof(e) {
    return (_typeof = "function" == typeof Symbol && "symbol" == typeof Symbol.iterator ? function(e) {
        return typeof e
    }
    : function(e) {
        return e && "function" == typeof Symbol && e.constructor === Symbol && e !== Symbol.prototype ? "symbol" : typeof e
    }
    )(e)
}
$define(["cmsAjax", "pl_toast", "captcha", "formUtil"], function(c, t, cp, f) {
    var init = function init() {
        var glp = this._params, compId = glp.id, cid = glp.cid, scp = this.scope, prop = glp.propJson, form = scp.closest("[class^='e_form-']"), formElemId, formProp, formItem, formItemArr, allFormItemArr, isForm, dataObj;
        function addDisabled(e) {
            e ? scp.addClass("disabled") : scp.removeClass("disabled")
        }
        function interactiveForm() {
            prop.business.forEach(function(e) {
                var t;
                e.state && (t = f.txRule(e, !1, cid),
                f.txRule(e, !0, cid) || t ? f.doAction(e.then, !0, formElemId, cid, prop.logic) : f.doAction(e.then, !1, formElemId, cid, prop.logic))
            });
            var o = [];
            prop.logic.forEach(function(r) {
                var e = r.formula.find(function(e) {
                    return "subFormRow" == e.type
                })
                  , n = "";
                r.relayRule || (n = f.calculation(r.formula, cid),
                r.output && (e ? form.find(".".concat(e.subform)).find(".p_tr").each(function(e, t) {
                    var o = "";
                    0 != e && (o = "__" + (e + 1));
                    var a = $(t).find('[name="'.concat(r.output).concat(o, '"]'));
                    0 == a.length && (a = $(t).find('[data-name="'.concat(r.output).concat(o, '"]'))),
                    a.val(n[e])
                }) : (0 == (e = form.find('[name="' + r.output + '"]')).length && (e = form.find('[data-name="' + r.output + '"]')),
                e.val(n)))),
                o.push(n)
            });
            var a = prop.prompt
              , e = a.match(/\$\{.*?\}/g);
            e && e.forEach(function(e) {
                var t = e.replace("${", "").replace("}", "").split("|")
                  , t = o[t[1]];
                a = a.replace(e, t)
            }),
            a && toastFun(a)
        }
        function formCalculation(e) {
            var t = [];
            return e.forEach(function(e) {
                e = f.calculation(e.formula, cid);
                t.push(e)
            }),
            t
        }
        function resetForm() {
            var e, t;
            2 == prop.type && 1 == prop.reload || 1 == prop.type && 1 == formProp.submit.obj1.reload || !prop.reload ? location.reload() : (e = window.location.origin + "/api/get_comp",
            t = {
                compId: cid,
                view: pageObj.filename,
                params: "{}"
            },
            c.cmsAjax.postJson(e, t, {
                dataType: "html"
            }).then(function(e) {
                var o = "";
                $(e).each(function(e, t) {
                    $(t).hasClass(formElemId) ? o = t : 0 < $(t).find("." + formElemId).length && (o = $(t).find("." + formElemId))
                }),
                form.html($(o).children());
                var e = form.find('[class^="e_"]')
                  , t = [];
                e.each(function() {
                    var e;
                    "true" == $(this).attr("needjs") && (e = $(this).attr("class").split(/\s+/)[0],
                    -1 == t.indexOf(e) && t.push(e))
                }),
                t.forEach(function(e) {
                    doElementJs(e, function() {}, cid)
                }),
                addDisabled(!1)
            }))
        }
        function submitForm() {
            if (checkFormValid()) {
                var e = form.find("[class^='e_agreement-']");
                if (0 < e.length) {
                    var t = !0;
                    if (e.each(function() {
                        $(this).find("[name^='e_agreement-']").prop("checked") || $(this).find("[data-name^='e_agreement-']").prop("checked") || (t = !1)
                    }),
                    !t)
                        return void toastFun(i18n.form_agreement)
                }
                var o, a = form.find("[class^='e_code-']");
                0 < a.length ? (o = a.eq(0).attr("class").split(/\s+/).find(function(e) {
                    return /^e_/.test(e)
                }),
                "image" == (e = f.getProp(o, cid)).type ? $require(["imageCaptcha"], function(e) {
                    e.check(function(e) {
                        dataObj[o] = e,
                        setFormData()
                    }, a)
                }) : $.captcha(function(e) {
                    dataObj[o] = e,
                    setFormData()
                }, e.type)) : setFormData()
            }
        }
        function checkFormValid() {
            var e, t, o = form.find(".is-invalid").length;
            return 0 < o ? ((e = form.find(".is-invalid").eq(0)).focus(),
            ((t = e.closest('[class^="e_"]').offset()).top < $(window).scrollTop() || t.top > $(window).scrollTop() + $(window).height()) && $("html, body").animate({
                scrollTop: t.top
            }, 200),
            !1) : (allFormItemArr.forEach(function(e) {
                var t, o, a = form.find("." + e);
                a.is(":visible") && (0 == (t = a.find("[name='" + e + "']")).length && (t = a.find("[data-name='" + e + "']")),
                /^e_rangeDate-/.test(e) ? (t = a.find("[name='" + e + "-start']"),
                o = a.find("[name='" + e + "-end']"),
                0 == t.length && (t = a.find("[data-name='" + e + "-start']")),
                0 == o.length && (o = a.find("[data-name='" + e + "-end']"))) : /^e_emailCode-/.test(e) || /^e_mobileCode-/.test(e) ? (t = a.find("[name='" + e + "-Number']"),
                o = a.find("[name='" + e + "-Code']"),
                0 == t.length && (t = a.find("[data-name='" + e + "-Number']")),
                0 == o.length && (o = a.find("[data-name='" + e + "-Code']"))) : (/^e_relevantItem-/.test(e) || /^e_code-/.test(e)) && (t = a.find("." + e)),
                0 != t.parents("[class^=e_subForm-]").length && !/^e_subForm-/.test(e) || (t && t.trigger("valid"),
                o && o.trigger("valid")))
            }),
            0 < (o = form.find(".is-invalid").length) && ((e = form.find(".is-invalid").eq(0)).focus(),
            ((t = e.closest('[class^="e_"]').offset()).top < $(window).scrollTop() || t.top > $(window).scrollTop() + $(window).height()) && $("html, body").animate({
                scrollTop: t.top
            }, 200)),
            0 == o)
        }
        function setFormData() {
            var e;
            formLimitFun() || (Object.assign(dataObj, getFormData()),
            4 != formProp.submit.type ? dataObj.formId && (addDisabled(!0),
            e = {
                headers: {
                    appId: formProp.basic.formInfo.app,
                    tenantId: tenant.tenantId,
                    psession: getCookie("psession")
                }
            },
            c.cmsAjax.postJson("/fwebapi/form/lowcode/content/add", dataObj, e).then(function(e) {
                200 == e.status ? (afterSubmit(dataObj),
                $(window).trigger("formSuccess", {
                    cid: cid,
                    eid: compId
                })) : (addDisabled(!1),
                "2003002039" == e.data.code || "2003002040" == e.data.code || "2003002041" == e.data.code ? toastFun(e.data.errorMsg) : toastFun(i18n.form_submitFail),
                $(window).trigger("formFaile", {
                    cid: cid,
                    eid: compId
                }))
            })) : toPageFun(dataObj, formProp.submit))
        }
        function toPageFun(e, t) {
            var a = form.find("[name='jumpPage']").val();
            a && (t.obj2.value.params.forEach(function(t) {
                if ("form" == t.type) {
                    var e = f.getElemValue(t.value, cid)
                      , o = e;
                    switch (Object.prototype.toString.call(e)) {
                    case "[object String]":
                    case "[object Number]":
                        o = e ? encodeURIComponent(e) : "";
                        break;
                    case "[object Object]":
                        o = "label" == t.valueType ? e.label ? encodeURIComponent(e.label) : "" : e.value ? encodeURIComponent(e.value) : "";
                        break;
                    case "[object Array]":
                        o = [],
                        e.forEach(function(e) {
                            "label" == t.valueType ? e.label && o.push(e.label ? encodeURIComponent(e.label) : "") : e.value && o.push(e.value ? encodeURIComponent(e.value) : "")
                        }),
                        o = "array[" + o.join(",") + "]"
                    }
                    a = -1 < a.indexOf(t.value) && -1 == a.indexOf("?") ? a.replace(new RegExp(t.value,"g"), o) : $.changeUrlArg(a, t.param, o)
                }
            }),
            "_blank" == t.obj2.target ? $.openNewWindow(a) : $.openHref(a))
        }
        function afterSubmit(dataObj) {
            var obj = formProp.submit, result, matchArr, prompt, id, size, relevantItem, relevantItemId, telemIdArr, relevantItemProp, dataList, subForm, isInSubForm;
            1 == obj.type ? 1 == obj.obj1.result ? (result = formCalculation(obj.logic),
            matchArr = obj.obj1.prompt.match(/\$\{.*?\}/g),
            prompt = obj.obj1.prompt,
            matchArr && matchArr.forEach(function(e) {
                var t = e.replace("${", "").replace("}", "").split("|")
                  , t = result[t[1]];
                prompt = prompt.replace(e, t)
            }),
            prompt ? toastFun({
                msg: prompt,
                hide: function() {
                    resetForm()
                }
            }) : resetForm()) : 2 == obj.obj1.result && obj.obj1.request.forEach(function(e) {
                if (e.state && e.isCompare) {
                    var value, result = formCalculation(obj.logic);
                    if (/^e_/.test(e.if.item)) {
                        var tmpvalue = f.getElemValue(e.if.item, cid);
                        switch (Object.prototype.toString.call(tmpvalue)) {
                        case "[object String]":
                            value = tmpvalue;
                            break;
                        case "[object Object]":
                            value = [tmpvalue.value];
                            break;
                        case "[object Array]":
                            value = [],
                            tmpvalue.forEach(function(e) {
                                value.push(e.value)
                            })
                        }
                    } else
                        value = result[e.if.item.split("_")[1]];
                    var bds = value + e.if.compare + e.if.value, bdsResult = Boolean(eval(bds)), matchArr;
                    bdsResult && (matchArr = e.prompt.match(/\$\{.*?\}/g),
                    matchArr && matchArr.forEach(function(t) {
                        var o = t.replace("${", "").replace("}", "").split("|")
                          , o = result[o[1]];
                        e.prompt = e.prompt.replace(t, o)
                    }),
                    toastFun(e.prompt))
                }
            }) : 2 == obj.type ? toPageFun(dataObj, obj) : 3 == obj.type && (id = [],
            size = [],
            relevantItem = form.find("[class^='e_relevantItem-']").eq(0),
            relevantItem && (telemIdArr = relevantItem.attr("class").split(/\s+/),
            telemIdArr.forEach(function(e) {
                e && /^e_relevantItem-/.test(e) && (relevantItemId = e)
            }),
            relevantItemProp = f.getProp(relevantItemId, cid),
            relevantItemProp.datasource.id == obj.obj3.idsource && (dataList = [],
            subForm = relevantItem.closest("[class^=e_subForm-]"),
            isInSubForm = 0 < subForm.length,
            isInSubForm ? subForm.find(".p_tr:visible").each(function() {
                var e = $(this).find(".p_relevantCon").attr("dataobj");
                0 < $(this).height() && e && (dataList.push(JSON.parse(unescape(e))),
                e = $(this).find("[name^=" + obj.obj3.size + "]").val(),
                size.push(e))
            }) : relevantItem.find(".p_tabelList tbody tr").each(function() {
                var e = $(this).attr("dataobj");
                dataList.push(JSON.parse(unescape(e)));
                e = form.find("[name=" + obj.obj3.size + "]");
                0 == e.length && (e = form.find("[data-name=" + obj.obj3.size + "]"));
                e = e.val();
                size.push(e)
            }),
            dataList.forEach(function(e) {
                id.push(e[obj.obj3.iditem])
            }),
            submitToOrder(id, size, dataObj))))
        }
        function submitToOrder(e, t, n) {
            var i, o, l = {
                subForm: [],
                normal: []
            }, s = ["e_subForm", "e_relevantItem", "e_uploadFile", "e_uploadImg", "e_uploadVideo", "e_mobileCode", "e_emailCode", "e_code"];
            for (i in n) {
                var m = i.split("-")[0];
                /^e_subForm-/.test(i) && function() {
                    var e, t = n[i], o = !0, a = [], r = [];
                    for (e in t[0])
                        -1 < s.indexOf(m) ? o = !1 : a.push({
                            key: e,
                            label: f.getElemLabel(e, cid)
                        });
                    o && (t.forEach(function(e) {
                        var o, a = {};
                        for (o in e) {
                            var t = o.split("-")[0];
                            /^e_/.test(o) && -1 == s.indexOf(t) && ("[object Array]" == Object.prototype.toString.call(e[o]) ? function() {
                                var t = [];
                                e[o].forEach(function(e) {
                                    t.push(e.label)
                                }),
                                a[o] = t.join(",")
                            }() : "[object Object]" == Object.prototype.toString.call(e[o]) ? e[o].callingCode ? a[o] = e[o].callingCode + e[o].countryCode + " " + e[o].phoneNumber : e[o].start ? a[o] = e[o].start + " -- " + e[o].end : a[o] = e[o].label : a[o] = e[o])
                        }
                        r.push(a)
                    }),
                    l.subForm.push({
                        head: a,
                        list: r
                    }))
                }()
            }
            for (o in n) {
                var a, r = o.split("-")[0];
                /^e_/.test(o) && -1 == s.indexOf(r) && (a = {
                    label: f.getElemLabel(o, cid)
                },
                "[object Array]" == Object.prototype.toString.call(n[o]) ? function() {
                    var t = [];
                    n[o].forEach(function(e) {
                        t.push(e.label)
                    }),
                    a.value = t.join(",")
                }() : "[object Object]" == Object.prototype.toString.call(n[o]) ? n[o].callingCode ? a.value = n[o].callingCode + n[o].countryCode + " " + n[o].phoneNumber : n[o].start ? a.value = n[o].start + " -- " + n[o].end : a.value = n[o].label : a.value = n[o],
                l.normal.push(a))
            }
            sessionStorage.setItem("orderFormJson", JSON.stringify(l));
            t = "/sys/settlement?from=form&skuId=" + e.join(",") + "&quantity=" + t.join(",");
            location.href = t
        }
        function formLimitFun() {
            var e = !1;
            return (formMemberLimit() || formTimeLimit()) && (e = !0),
            e
        }
        function formMemberLimit() {}
        function formTimeLimit() {
            var e, t, o, a = formProp.basic.submitTime, r = !1;
            return 1 == a.limit && (e = +new Date,
            t = +new Date(a.startTime),
            o = +new Date(a.endTime),
            (e < t || o < e) && (r = !0,
            toastFun(a.prompt))),
            r
        }
        function getFormData() {
            return formItemArr.forEach(function(e) {
                var t = e.split("-")[0];
                if (-1 < ["e_formBtn", "e_agreement", "e_code"].indexOf(t))
                    return !0;
                dataObj[e] = f.getElemValue(e, cid)
            }),
            dataObj
        }
        function toastFun(e) {
            var t, o = {
                time: void 0 === formProp.submit.obj1.promptTime ? 2 : formProp.submit.obj1.promptTime
            };
            "string" == typeof e || "number" == typeof e ? t = o.msg = e : "object" == _typeof(e) && (o = Object.assign(o, e),
            t = e.msg);
            formProp.basic.promptDom && '<div class="pl_toast">\n     <span class="pl_toast_con"><span>%{tishi_zhanwei}%</span></span>\n</div>\n\x3c!--\n%{tishi_zhanwei}%为变量，不可删除\n样式名pl_toast最外层容器不可删除\n--\x3e' != formProp.basic.promptDom && (e = (e = form.find(".ptishiCon .pl_toast").prop("outerHTML")).replace(/\%\{tishi_zhanwei\}\%/g, t),
            o.html = e),
            $.pl_toast(o)
        }
        0 != form.length && (formElemId = form.attr("class").split(/\s+/).find(function(e) {
            return /^e_/.test(e)
        }),
        formProp = f.getProp(formElemId, cid),
        formItem = form.find("[class^='e_']"),
        formItemArr = [],
        allFormItemArr = [],
        isForm = ["e_form", "e_input", "e_number", "e_textarea", "e_select", "e_multipleSelect", "e_radio", "e_checkbox", "e_label", "e_date", "e_rangeDate", "e_score", "e_formBtn", "e_address", "e_uploadImg", "e_uploadFile", "e_uploadVideo", "e_subForm", "e_relevantItem", "e_agreement", "e_code", "e_mobileCode", "e_emailCode", "e_cardLabel", "e_clueMobile", "e_clueName", "e_clueEmail"],
        formItem.each(function() {
            var e = $(this).attr("class").split(/\s+/).find(function(e) {
                return /^e_/.test(e)
            });
            -1 < isForm.indexOf(e.split("-")[0]) && (0 == $(this).parents('[class^="e_subForm-"]').length && formItemArr.push(e),
            $(this).hasClass("formHide") || allFormItemArr.push(e))
        }),
        dataObj = {
            formId: formProp.formId,
            terminal: $.getTerminal()
        },
        scp.on("enterSubmit", function(e, t) {
            1 == prop.type && scp.trigger("click")
        }),
        scp.click(function() {
            $(this).hasClass("disabled") || (1 == prop.type ? submitForm() : 2 == prop.type ? resetForm() : 3 == prop.type && 1 == prop.action && interactiveForm())
        }))
    };
    return {
        init: init
    }
});
